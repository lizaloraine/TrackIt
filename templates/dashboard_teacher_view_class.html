<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Teacher — View Class</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    /* Minimal inline styles for quick copy-paste; replace with your app CSS */
    .attendance-controls { display:flex; gap:12px; align-items:center; margin-bottom:12px; }
    .student-row { display:flex; gap:12px; align-items:center; padding:6px 0; border-bottom:1px solid #eee; }
    .btn-save { padding:8px 12px; cursor:pointer; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Class: {{ class_code }} — Section: {{ section }}</h2>

    <div class="attendance-controls" style="margin-top:8px;">
      <label>
        Date:
        <input id="attendance-date" type="date">
      </label>

      <label>
        Time:
        <input id="attendance-time" type="time">
      </label>

      <button id="save-attendance-btn" class="btn-save">Save changes</button>
    </div>

    <div id="students-list">
      {% for s in students %}
      <div class="student-row" data-student-id="{{ s.student_id }}">
        <div style="flex:1;">
          <strong>{{ s.name or s.student_id }}</strong>
        </div>
        <div>
          <select class="att-status">
            <option value="present" {% if s.status == 'present' %}selected{% endif %}>Present</option>
            <option value="absent" {% if s.status == 'absent' %}selected{% endif %}>Absent</option>
            <option value="excused" {% if s.status == 'excused' %}selected{% endif %}>Excused</option>
          </select>
        </div>
      </div>
      {% endfor %}
    </div>

    <p><a href="{{ url_for('dashboard_teacher_classes') }}">Back to Classes</a></p>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const saveBtn = document.getElementById('save-attendance-btn');
    const dateInput = document.getElementById('attendance-date');
    const timeInput = document.getElementById('attendance-time');

    // default date to today
    if (!dateInput.value) {
      const today = new Date();
      dateInput.value = today.toISOString().slice(0,10);
    }
    // default time to current HH:MM
    if (!timeInput.value) {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2,'0');
      const mm = String(now.getMinutes()).padStart(2,'0');
      timeInput.value = `${hh}:${mm}`;
    }

    saveBtn.addEventListener('click', async function() {
      const rows = document.querySelectorAll('#students-list .student-row');
      const attendance = Array.from(rows).map(r => {
        return {
          student_id: r.getAttribute('data-student-id'),
          status: r.querySelector('.att-status').value
        };
      });

      const payload = {
        attendance: attendance,
        date: dateInput.value,
        time: timeInput.value
      };

      try {
        const resp = await fetch('{{ url_for("save_attendance_route", class_code=class_code, section=section) }}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (data && data.status === 'success') {
          alert('Attendance saved. Recorded at: ' + (data.recorded_at || 'server time'));
        } else {
          alert('Save failed: ' + (data.message || 'unknown error'));
        }
      } catch (err) {
        console.error(err);
        alert('Error saving attendance. Check console for details.');
      }
    });
  });
  </script>
</body>
</html>
