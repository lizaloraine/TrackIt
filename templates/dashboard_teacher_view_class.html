<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Teacher — View Class</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard_teacher_view_class.css') }}">
  <style>
    /* ---------- GENERAL ---------- */
    .save-btn { 
      background:#8a0000; color:#fff; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:600; 
    }
    .save-btn:hover { background:#6b0000; }

    /* ---------- POPUP ---------- */
    .popup-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #4BB543; /* green success */
      color: white;
      padding: 14px 20px;
      border-radius: 8px;
      font-weight: 600;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      z-index: 1500;
    }
    .popup-notification.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>

<body>

<!-- SIDEBAR -->
<aside id="sidebar" class="sidebar">
  <h2 id="sidebarTitle" class="sidebar-title">TrackIt</h2>
  <nav class="sidebar-menu">
    <a href="{{ url_for('dashboard') }}" class="side-link">Home</a>
    <a href="{{ url_for('dashboard_teacher_class') }}" class="side-link">Class</a>
    <a href="{{ url_for('dashboard_teacher_view_class', class_code=class_code, section=section) }}" class="side-link">View Class</a>
    <a href="{{ url_for('logout') }}" class="side-link">Logout</a>
  </nav>
</aside>

<!-- PAGE CONTENT -->
<div id="content">
<header class="header-bar">
  <button id="toggleSidebar" class="burger-btn">
    <span></span><span></span><span></span>
  </button>
  <div class="header-right">
    <div class="user-icon"></div>
    <a href="{{ url_for('logout') }}" class="logout-link">Logout</a>
  </div>
</header>

<div class="page-title">
  Classes > {{ class_code }}
</div>

<div class="section-header">
  <span>{{ section }}</span>
  <button id="save-attendance-btn" class="save-btn">Save Attendance</button>
</div>

<div class="white-card">
  <h3>{{ class_code }} — {{ section }}</h3>

  <table class="table">
    <thead>
      <tr>
        <th style="width:50%;">Student Name</th>
        <th>Present</th>
        <th>Absent</th>
        <th>Excused</th>
      </tr>
    </thead>
    <tbody>
      {% for s in students %}
      <tr data-student-id="{{ s.student_id }}"
        data-name="{{ s.name or s.student_id }}">
        <td>{{ s.name or s.student_id }}</td>

        <td><input type="radio" name="status_{{ s.student_id }}" value="present" {% if s.status == 'present' %}checked{% endif %}></td>
        <td><input type="radio" name="status_{{ s.student_id }}" value="absent" {% if s.status == 'absent' %}checked{% endif %}></td>
        <td><input type="radio" name="status_{{ s.student_id }}" value="excused" {% if s.status == 'excused' %}checked{% endif %}></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <br>
  <a href="{{ url_for('dashboard') }}" class="back-btn">Back</a>
</div>
</div> 

<!-- POPUP -->
<div id="popupNotification" class="popup-notification">Attendance saved successfully!</div>

<script>
  // Sidebar toggle
  const sidebar = document.getElementById("sidebar");
  const toggle = document.getElementById("toggleSidebar");
  const title = document.getElementById("sidebarTitle");

  toggle.addEventListener("click", () => sidebar.classList.toggle("open"));
  title.addEventListener("click", () => sidebar.classList.remove("open"));

  // Save Attendance function
  async function saveAttendance() {
    const rows = document.querySelectorAll("tbody tr");
    const attendance = Array.from(rows).map(row => {
      const id = row.dataset.studentId;
      const selected = row.querySelector("input[type=radio]:checked")?.value || "absent";
      return { student_id: id, status: selected };
    });

    const payload = {
      attendance,
      timestamp: new Date().toISOString() // real-time timestamp
    };

    try {
      const resp = await fetch(
        "{{ url_for('save_attendance_route', class_code=class_code, section=section) }}",
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        }
      );

      const data = await resp.json();
      if(data.status === "success") {
        showPopup("Attendance saved successfully!");
        console.log("Saved at " + payload.timestamp);
      } else {
        showPopup("Failed: " + data.message, true);
      }
    } catch (err) {
      console.error(err);
      showPopup("Error saving attendance.", true);
    }
  }

  // Trigger save only on button click
  document.getElementById("save-attendance-btn").addEventListener("click", saveAttendance);

  // Popup function
  const popup = document.getElementById("popupNotification");
  function showPopup(message, isError=false) {
    popup.textContent = message;
    popup.style.background = isError ? "#e74c3c" : "#4BB543";
    popup.classList.add("show");
    setTimeout(() => popup.classList.remove("show"), 2500);
  }




   document.addEventListener("DOMContentLoaded", () => {
    const tbody = document.querySelector("tbody");
    if (!tbody) return;

    const rows = Array.from(tbody.querySelectorAll("tr"));

    rows.sort((a, b) => {
      const nameA = (a.dataset.name || "").trim().toLowerCase();
      const nameB = (b.dataset.name || "").trim().toLowerCase();

      // get last word (surname)
      const lastA = nameA.split(" ").pop();
      const lastB = nameB.split(" ").pop();

      // primary sort: surname
      if (lastA !== lastB) {
        return lastA.localeCompare(lastB);
      }

      // secondary sort: full name (fallback)
      return nameA.localeCompare(nameB);
    });

    // re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
  });
</script>

</body>
</html>
